#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>

// ==========================================
// 配置与定义
// ==========================================
// TODO: 请将此处的 ******** 替换为你的实际文件路径
#define FILE_PATH "********"
#define MAX_NAME 50
#define MAX_ID 20
#define MAX_STUDENTS 1000

// 定义学生结构体
typedef struct {
    char name[MAX_NAME];
    char id[MAX_ID];
    double computer_score;
    double math_score;
    double linear_algebra_score;
} Student;

// ==========================================
// 函数声明
// ==========================================
// 基础操作
void addStudent();
void displayAllStudents();
void calculateAverages();
void searchStudent();
void modifyStudent();

// 新增功能
void totalRanking();
void subjectRanking();

// 辅助函数
void trimNewline(char *str);
int loadStudents(Student students[]);
void saveStudents(Student students[], int count);
int isIdExists(char *id); // 检查学号重复

// 排行榜辅助 (qsort比较函数)
int compareTotal(const void *a, const void *b);
int compareSubject(const void *a, const void *b);
int sortSubjectFlag; // 全局标志位，用于单科排序

// 可视化辅助
void drawBar(int length, const char* symbol);

// ==========================================
// 主函数
// ==========================================
int main() {
    int choice;

    printf("=== 欢迎使用学生管理系统 ===\n");
    
    while (1) {
        printf("\n========== 菜单 ==========\n");
        printf("1. 录入学生信息\n");
        printf("2. 显示所有信息\n");
        printf("3. 计算各科平均分\n");
        printf("4. 查询学生信息 (含可视化图表)\n");
        printf("5. 修改学生信息\n");
        printf("6. 总分排行榜\n");
        printf("7. 单科排行榜\n");
        printf("0. 退出程序\n");
        printf("请选择操作 (0-7): ");
        
        if (scanf("%d", &choice) != 1) {
            printf("输入无效，请输入数字。\n");
            while (getchar() != '\n'); // 清空缓冲区
            continue;
        }
        getchar(); // 吃掉换行符

        switch (choice) {
            case 1: addStudent(); break;
            case 2: displayAllStudents(); break;
            case 3: calculateAverages(); break;
            case 4: searchStudent(); break;
            case 5: modifyStudent(); break;
            case 6: totalRanking(); break;
            case 7: subjectRanking(); break;
            case 0: 
                printf("感谢使用，再见！\n");
                exit(0);
            default:
                printf("无效选择，请重新输入。\n");
        }
    }
    return 0;
}

// ==========================================
// 功能实现
// ==========================================

// 1. 录入学生信息 (带查重)
void addStudent() {
    Student s;
    printf("请输入学生姓名: ");
    fgets(s.name, MAX_NAME, stdin);
    trimNewline(s.name);

    // 学号查重循环
    while (1) {
        printf("请输入学生学号: ");
        fgets(s.id, MAX_ID, stdin);
        trimNewline(s.id);

        if (isIdExists(s.id)) {
            printf("❌ 错误：学号 [%s] 已经存在！请重新输入或选择修改功能。\n", s.id);
        } else {
            break; // 学号唯一，跳出循环
        }
    }

    printf("请输入计算机成绩: ");
    while (scanf("%lf", &s.computer_score) != 1) {
        printf("输入无效，请输入数字: ");
        while (getchar() != '\n');
    }

    printf("请输入高等数学成绩: ");
    while (scanf("%lf", &s.math_score) != 1) {
        printf("输入无效，请输入数字: ");
        while (getchar() != '\n');
    }

    printf("请输入线性代数成绩: ");
    while (scanf("%lf", &s.linear_algebra_score) != 1) {
        printf("输入无效，请输入数字: ");
        while (getchar() != '\n');
    }
    getchar(); // 吃掉最后的换行

    // 追加写入文件
    FILE *file = fopen(FILE_PATH, "a");
    if (file == NULL) {
        printf("错误：无法打开文件 %s 进行写入！\n", FILE_PATH);
        return;
    }
    fprintf(file, "%s,%s,%.2f,%.2f,%.2f\n", 
            s.name, s.id, s.computer_score, s.math_score, s.linear_algebra_score);
    fclose(file);

    printf("✅ 学生 %s (学号: %s) 录入成功！\n", s.name, s.id);
}

// 2. 显示所有学生信息
void displayAllStudents() {
    Student students[MAX_STUDENTS];
    int count = loadStudents(students);

    if (count == 0) {
        printf("暂无学生数据。\n");
        return;
    }

    printf("\n%-15s %-15s %-12s %-12s %-12s\n", "姓名", "学号", "计算机", "高数", "线性代数");
    printf("------------------------------------------------------------\n");
    for (int i = 0; i < count; i++) {
        printf("%-15s %-15s %-12.2f %-12.2f %-12.2f\n", 
               students[i].name, students[i].id, 
               students[i].computer_score, students[i].math_score, 
               students[i].linear_algebra_score);
    }
    printf("共 %d 条记录。\n", count);
}

// 3. 计算各科平均分
void calculateAverages() {
    Student students[MAX_STUDENTS];
    int count = loadStudents(students);

    if (count == 0) {
        printf("暂无数据可计算。\n");
        return;
    }

    double total_comp = 0, total_math = 0, total_linear = 0;
    for (int i = 0; i < count; i++) {
        total_comp += students[i].computer_score;
        total_math += students[i].math_score;
        total_linear += students[i].linear_algebra_score;
    }

    printf("\n========== 各科平均分 ==========\n");
    printf("计算机平均分: %.2f\n", total_comp / count);
    printf("高等数学平均分: %.2f\n", total_math / count);
    printf("线性代数平均分: %.2f\n", total_linear / count);
}

// 4. 查询学生信息 (含可视化图表)
void searchStudent() {
    Student students[MAX_STUDENTS];
    int count = loadStudents(students);
    if (count == 0) {
        printf("暂无学生数据。\n");
        return;
    }

    char keyword[MAX_NAME];
    printf("请输入要查询的姓名或学号: ");
    fgets(keyword, MAX_NAME, stdin);
    trimNewline(keyword);

    // 查找学生
    Student target;
    int found = 0;
    for (int i = 0; i < count; i++) {
        if (strcmp(students[i].name, keyword) == 0 || strcmp(students[i].id, keyword) == 0) {
            target = students[i];
            found = 1;
            break;
        }
    }

    if (!found) {
        printf("未找到该学生。\n");
        return;
    }

    // 计算班级平均分
    double avg_comp = 0, avg_math = 0, avg_linear = 0;
    for (int i = 0; i < count; i++) {
        avg_comp += students[i].computer_score;
        avg_math += students[i].math_score;
        avg_linear += students[i].linear_algebra_score;
    }
    avg_comp /= count;
    avg_math /= count;
    avg_linear /= count;

    // 可视化绘图
    double scale = 0.3; // 比例尺：分数每10分对应3个字符长度

    printf("\n");
    printf("========================================\n");
    printf("      学生成绩可视化分析报告\n");
    printf("姓名: %s | 学号: %s\n", target.name, target.id);
    printf("----------------------------------------\n");

    // 计算机
    printf("科目: 计算机基础\n");
    printf("分数: %.2f | 班级平均: %.2f\n", target.computer_score, avg_comp);
    printf("个人: ");
    drawBar((int)(target.computer_score * scale), "█");
    printf(" %.2f\n", target.computer_score);
    printf("平均: ");
    drawBar((int)(avg_comp * scale), "*");
    printf(" %.2f\n", avg_comp);
    printf("\n");

    // 高等数学
    printf("科目: 高等数学\n");
    printf("分数: %.2f | 班级平均: %.2f\n", target.math_score, avg_math);
    printf("个人: ");
    drawBar((int)(target.math_score * scale), "█");
    printf(" %.2f\n", target.math_score);
    printf("平均: ");
    drawBar((int)(avg_math * scale), "*");
    printf(" %.2f\n", avg_math);
    printf("\n");

    // 线性代数
    printf("科目: 线性代数\n");
    printf("分数: %.2f | 班级平均: %.2f\n", target.linear_algebra_score, avg_linear);
    printf("个人: ");
    drawBar((int)(target.linear_algebra_score * scale), "█");
    printf(" %.2f\n", target.linear_algebra_score);
    printf("平均: ");
    drawBar((int)(avg_linear * scale), "*");
    printf(" %.2f\n", avg_linear);
    printf("----------------------------------------\n");
    printf("注: █ 代表个人成绩柱状图, * 代表班级平均分基准线\n");
}

// 5. 修改学生信息
void modifyStudent() {
    Student students[MAX_STUDENTS];
    int count = loadStudents(students);
    if (count == 0) {
        printf("暂无数据可修改。\n");
        return;
    }

    char keyword[MAX_NAME];
    printf("请输入要修改的学生姓名或学号: ");
    fgets(keyword, MAX_NAME, stdin);
    trimNewline(keyword);

    int index = -1;
    for (int i = 0; i < count; i++) {
        if (strcmp(students[i].name, keyword) == 0 || strcmp(students[i].id, keyword) == 0) {
            index = i;
            break;
        }
    }

    if (index == -1) {
        printf("未找到该学生。\n");
        return;
    }

    printf("当前信息 -> 姓名: %s, 学号: %s\n", students[index].name, students[index].id);
    printf("计算机: %.2f, 高数: %.2f, 线性代数: %.2f\n", 
           students[index].computer_score, students[index].math_score, students[index].linear_algebra_score);

    // 修改逻辑
    printf("请输入新的计算机成绩 (输入-1保持不变): ");
    double temp;
    scanf("%lf", &temp);
    if (temp >= 0) students[index].computer_score = temp;

    printf("请输入新的高等数学成绩 (输入-1保持不变): ");
    scanf("%lf", &temp);
    if (temp >= 0) students[index].math_score = temp;

    printf("请输入新的线性代数成绩 (输入-1保持不变): ");
    scanf("%lf", &temp);
    if (temp >= 0) students[index].linear_algebra_score = temp;
    getchar(); 

    saveStudents(students, count);
    printf("✅ 学生信息修改成功！\n");
}

// 6. 总分排行榜
void totalRanking() {
    Student students[MAX_STUDENTS];
    int count = loadStudents(students);
    if (count == 0) {
        printf("暂无数据。\n");
        return;
    }

    // 排序
    qsort(students, count, sizeof(Student), compareTotal);

    printf("\n");
    printf("========================================\n");
    printf("          总分排行榜\n");
    printf("========================================\n");
    printf("%-4s %-15s %-15s %-12s\n", "排名", "姓名", "学号", "总分");
    printf("----------------------------------------\n");

    for (int i = 0; i < count; i++) {
        double total = students[i].computer_score + students[i].math_score + students[i].linear_algebra_score;
        printf("%-4d %-15s %-15s %-12.2f\n", 
               i+1, students[i].name, students[i].id, total);
    }
}

// 7. 单科排行榜
void subjectRanking() {
    Student students[MAX_STUDENTS];
    int count = loadStudents(students);
    if (count == 0) {
        printf("暂无数据。\n");
        return;
    }

    int choice;
    printf("选择科目:\n1.计算机 2.高数 3.线性代数: ");
    scanf("%d", &choice);
    getchar();

    char *subjectName;
    switch (choice) {
        case 1: subjectName = "计算机"; sortSubjectFlag = 1; break;
        case 2: subjectName = "高等数学"; sortSubjectFlag = 2; break;
        case 3: subjectName = "线性代数"; sortSubjectFlag = 3; break;
        default: printf("无效选择。\n"); return;
    }

    qsort(students, count, sizeof(Student), compareSubject);

    printf("\n");
    printf("========================================\n");
    printf("          %s 排行榜\n", subjectName);
    printf("========================================\n");
    printf("%-4s %-15s %-15s %-12s\n", "排名", "姓名", "学号", "成绩");
    printf("----------------------------------------\n");

    for (int i = 0; i < count; i++) {
        double score;
        switch (choice) {
            case 1: score = students[i].computer_score; break;
            case 2: score = students[i].math_score; break;
            case 3: score = students[i].linear_algebra_score; break;
        }
        printf("%-4d %-15s %-15s %-12.2f\n", i+1, students[i].name, students[i].id, score);
    }
}

// ==========================================
// 辅助函数实现
// ==========================================

// 去除字符串换行符
void trimNewline(char *str) {
    int len = strlen(str);
    if (len > 0 && str[len - 1] == '\n') {
        str[len - 1] = '\0';
    }
}

// 从文件加载学生
int loadStudents(Student students[]) {
    FILE *file = fopen(FILE_PATH, "r");
    if (file == NULL) return 0;

    int count = 0;
    // 注意：这里假设文件中没有逗号，或者名字学号不含逗号
    // 如果格式复杂，需要更严谨的解析
    while (fscanf(file, "%49[^,],%19[^,],%lf,%lf,%lf\n", 
                  students[count].name, 
                  students[count].id, 
                  &students[count].computer_score, 
                  &students[count].math_score, 
                  &students[count].linear_algebra_score) == 5) {
        count++;
        if (count >= MAX_STUDENTS) break;
    }
    fclose(file);
    return count;
}

// 保存学生到文件
void saveStudents(Student students[], int count) {
    FILE *file = fopen(FILE_PATH, "w");
    if (file == NULL) {
        printf("错误：无法打开文件 %s 进行写入！\n", FILE_PATH);
        return;
    }
    for (int i = 0; i < count; i++) {
        fprintf(file, "%s,%s,%.2f,%.2f,%.2f\n", 
                students[i].name, students[i].id, 
                students[i].computer_score, students[i].math_score, 
                students[i].linear_algebra_score);
    }
    fclose(file);
}

// 检查学号是否已存在
int isIdExists(char *id) {
    Student students[MAX_STUDENTS];
    int count = loadStudents(students);
    for (int i = 0; i < count; i++) {
        if (strcmp(students[i].id, id) == 0) {
            return 1;
        }
    }
    return 0;
}

// 绘制文本柱状图
void drawBar(int length, const char* symbol) {
    // 限制最大长度防止屏幕溢出
    int maxLen = 50; 
    if (length > maxLen) length = maxLen;
    for (int i = 0; i < length; i++) {
        printf("%s", symbol);
    }
}

// 比较函数：总分 (降序)
int compareTotal(const void *a, const void *b) {
    Student *sa = (Student *)a;
    Student *sb = (Student *)b;
    double sumA = sa->computer_score + sa->math_score + sa->linear_algebra_score;
    double sumB = sb->computer_score + sb->math_score + sb->linear_algebra_score;
    return (sumB > sumA) - (sumB < sumA);
}

// 比较函数：单科 (降序)
int compareSubject(const void *a, const void *b) {
    Student *sa = (Student *)a;
    Student *sb = (Student *)b;
    double scoreA, scoreB;

    switch (sortSubjectFlag) {
        case 1: scoreA = sa->computer_score; scoreB = sb->computer_score; break;
        case 2: scoreA = sa->math_score;     scoreB = sb->math_score;     break;
        case 3: scoreA = sa->linear_algebra_score; scoreB = sb->linear_algebra_score; break;
        default: return 0;
    }
    return (scoreB > scoreA) - (scoreB < scoreA);
}